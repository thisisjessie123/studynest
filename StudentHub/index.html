<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StudyNest Hub æ——è‰¦å®Œå…¨ç‰ˆ</title>
    <style>
        :root {
            --primary: #6366f1; --success: #22c55e; --danger: #ef4444; --warning: #f59e0b;
            --gray-100: #f3f4f6; --gray-800: #1f2937;
        }
        * { box-sizing: border-box; font-family: -apple-system, "PingFang TC", sans-serif; }
        body { margin: 0; background: #f8fafc; color: var(--gray-800); padding-bottom: 70px; }
        .header { background: white; padding: 15px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); sticky: top; }
        .tab-content { padding: 15px; display: none; }
        .tab-content.active { display: block; }
        
        /* å­¸ç”Ÿå¡ç‰‡èˆ‡è­¦ç¤º */
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); position: relative; }
        .balance-red { color: var(--danger); font-weight: bold; }
        .pill { font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px; vertical-align: middle; }
        .pill-med { background: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; }

        /* è¡¨å–®æ¨£å¼ */
        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 13px; margin-bottom: 4px; color: #64748b; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .btn { border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-mini { width: auto; padding: 5px 10px; font-size: 12px; }

        /* æ¥é€ä½å®¿å°ˆç”¨ */
        .stay-box { background: #f0f4ff; padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 4px solid var(--primary); }
        .finance-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        .summary-bar { background: #eef2ff; padding: 12px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-around; border: 1px solid #c3dafe; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 8px; background: #f1f5f9; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; }

        /* å°èˆªåˆ— */
        .nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; height: 60px; z-index: 100; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; color: #64748b; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        
        .status-todo { background: #ffedd5; color: #9a3412; }
        .status-doing { background: #dcfce7; color: #166534; }
        .status-done { background: #f1f5f9; color: #475569; }
    </style>
</head>
<body>

<div class="header">
    <h2 id="view-title">å­¸ç”Ÿç®¡ç†</h2>
</div>

<div id="view-students" class="tab-content active">
    <button class="btn btn-primary" onclick="showAddStudent()">+ æ–°å¢å­¸ç”Ÿæª”æ¡ˆ</button>
    <div id="student-list" style="margin-top:15px;"></div>
</div>

<div id="view-interactions" class="tab-content">
    <div class="form-group">
        <select id="inter-student-filter" onchange="renderInteractions()">
            <option value="all">æ‰€æœ‰å­¸ç”Ÿ</option>
        </select>
    </div>
    <div id="interaction-list"></div>
</div>

<div id="view-pocket" class="tab-content">
    <div class="form-group">
        <select id="pocket-student-filter" onchange="renderPocket()">
            <option value="all">æ‰€æœ‰å­¸ç”Ÿ</option>
        </select>
    </div>
    <div id="pocket-list"></div>
</div>

<div id="view-transport" class="tab-content">
    <button class="btn btn-primary" onclick="showAddTransport()">+ æ–°å¢è¡Œç¨‹ä»»å‹™</button>
    
    <h4 style="margin:20px 0 10px">é€²è¡Œä¸­ä»»å‹™</h4>
    <div id="transport-active-list"></div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px;">
        <h4 style="margin:0">æ­·å²å°å¸³</h4>
        <input type="month" id="transport-month-filter" style="width:auto;" onchange="renderTransport()">
    </div>
    <div id="transport-history-list" style="margin-top:10px;"></div>
</div>

<div class="nav">
    <div class="nav-item active" onclick="switchTab('students', this)">ğŸ‘¤ å­¸ç”Ÿ</div>
    <div class="nav-item" onclick="switchTab('transport', this)">ğŸš— æ¥é€</div>
    <div class="nav-item" onclick="switchTab('interactions', this)">ğŸ’¬ äº’å‹•</div>
    <div class="nav-item" onclick="switchTab('pocket', this)">ğŸ’° é›¶ç”¨</div>
</div>

<div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:200; overflow-y:auto; padding:20px;">
    <div id="modal-body" style="background:white; border-radius:15px; padding:20px;"></div>
</div>

<script>
let students = JSON.parse(localStorage.getItem('sn_students') || '[]');
let interactions = JSON.parse(localStorage.getItem('sn_inter') || '[]');
let pocketMoney = JSON.parse(localStorage.getItem('sn_pocket') || '[]');
let transports = JSON.parse(localStorage.getItem('sn_trans') || '[]');

function save() {
    localStorage.setItem('sn_students', JSON.stringify(students));
    localStorage.setItem('sn_inter', JSON.stringify(interactions));
    localStorage.setItem('sn_pocket', JSON.stringify(pocketMoney));
    localStorage.setItem('sn_trans', JSON.stringify(transports));
    render();
}

function switchTab(tab, el) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.getElementById('view-' + tab).classList.add('active');
    el.classList.add('active');
    document.getElementById('view-title').innerText = el.innerText.split(' ')[1];
    render();
}

// --- å­¸ç”Ÿç®¡ç†é‚è¼¯ ---
function showAddStudent() {
    const body = document.getElementById('modal-body');
    body.innerHTML = `
        <h3>æ–°å¢å­¸ç”Ÿæª”æ¡ˆ</h3>
        <div class="form-group"><label>å­¸ç”Ÿå§“å *</label><input id="s-name"></div>
        <div class="form-group"><label>ç›®å‰é¤˜é¡ (Â£) *</label><input type="number" id="s-balance" value="0"></div>
        <div class="form-group"><label>çˆ¶æ¯è¯ç¹«æ–¹å¼</label><input id="s-parent"></div>
        <div class="form-group"><label>å®¿ç®¡è³‡è¨Š</label><input id="s-house"></div>
        <div class="form-group"><label>åœ°å€</label><input id="s-addr"></div>
        <div class="form-group"><label>é†«ç™‚/éæ• (å¡«å¯«å¾Œå§“åæ—æœƒå‡ºç¾ğŸ’Š)</label><textarea id="s-med"></textarea></div>
        <div class="form-group"><label>ç”Ÿæ—¥</label><input type="date" id="s-bday"></div>
        <button class="btn btn-success" onclick="addStudent()">å„²å­˜æª”æ¡ˆ</button>
        <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
    `;
    document.getElementById('modal').style.display = 'block';
}

function addStudent() {
    const s = {
        id: Date.now().toString(),
        name: document.getElementById('s-name').value,
        balance: parseFloat(document.getElementById('s-balance').value) || 0,
        parent: document.getElementById('s-parent').value,
        house: document.getElementById('s-house').value,
        addr: document.getElementById('s-addr').value,
        med: document.getElementById('s-med').value,
        bday: document.getElementById('s-bday').value
    };
    students.push(s);
    save();
    closeModal();
}

// --- æ¥é€ä½å®¿é‚è¼¯ ---
function showAddTransport() {
    const sOptions = students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    const body = document.getElementById('modal-body');
    body.innerHTML = `
        <h3>æ–°å¢è¡Œç¨‹ä»»å‹™</h3>
        <div class="form-group"><label>é¸æ“‡å­¸ç”Ÿ</label><select id="t-sid">${sOptions}</select></div>
        <div class="form-group"><label>ä»»å‹™é¡å‹</label>
            <select id="t-type">
                <option>æ¥æ©Ÿ (Pick-up)</option><option>é€æ©Ÿ (Drop-off)</option>
                <option>å‡ºæ ¡ (Exit)</option><option>è¿”æ ¡ (Return)</option>
            </select>
        </div>
        <div class="form-group"><label>æ™‚é–“</label><input type="datetime-local" id="t-time"></div>
        <div class="form-group"><label>ç›®çš„åœ°</label>
            <input list="loc-list" id="t-loc">
            <datalist id="loc-list">
                <option value="LHR">LHR</option><option value="LGW">LGW</option>
                <option value="å­¸æ ¡">å­¸æ ¡</option><option value="ä½å®¶">ä½å®¶</option>
            </datalist>
        </div>
        <div class="form-group"><label>èˆªç­ / ä½å®¶åœ°å€</label><input id="t-info"></div>
        
        <div class="form-group">
            <label><input type="checkbox" id="t-isStay" onchange="toggleStay()"> æ­¤è¡Œç¨‹åŒ…å«ä½å®¿</label>
        </div>

        <div id="stay-fields" class="stay-box" style="display:none;">
            <div class="form-group"><label>Check-out æ—¥æœŸ</label><input type="date" id="t-stayEnd" onchange="calcNights()"></div>
            <p id="stay-nights-tip" style="font-size:12px; color:var(--primary); font-weight:bold;">è‡ªå‹•è¨ˆç®—ï¼š0 æ™š</p>
            <div class="form-group"><label>ä½å®¶å§“å</label><input id="t-hname"></div>
            <div class="form-group"><label>ä½å®¶è¯ç¹«æ–¹å¼</label><input id="t-hcontact"></div>
            <div class="finance-row">
                <div><label>ä½å®¿æˆæœ¬/æ™š (Net)</label><input type="number" id="t-stayNet" placeholder="Â£"></div>
                <div><label>ä½å®¿å ±åƒ¹/æ™š (Gross)</label><input type="number" id="t-stayGross" placeholder="Â£"></div>
            </div>
        </div>

        <div class="finance-row">
            <div><label>è»Šè³‡æˆæœ¬ (Net)</label><input type="number" id="t-transNet" placeholder="Â£"></div>
            <div><label>è»Šè³‡å ±åƒ¹ (Gross)</label><input type="number" id="t-transGross" placeholder="Â£"></div>
        </div>

        <div class="form-group">
            <label><input type="checkbox" id="t-syncInter" checked> åŒæ­¥å¯«å…¥äº’å‹•ç´€éŒ„</label>
        </div>

        <button class="btn btn-success" onclick="addTransport()">å„²å­˜è¡Œç¨‹</button>
        <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
    `;
    document.getElementById('modal').style.display = 'block';
}

function toggleStay() {
    document.getElementById('stay-fields').style.display = document.getElementById('t-isStay').checked ? 'block' : 'none';
}

function calcNights() {
    const start = new Date(document.getElementById('t-time').value.split('T')[0]);
    const end = new Date(document.getElementById('t-stayEnd').value);
    if(start && end && end > start) {
        const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
        document.getElementById('stay-nights-tip').innerText = `è‡ªå‹•è¨ˆç®—ï¼š${diff} æ™š`;
    }
}

function addTransport() {
    const isStay = document.getElementById('t-isStay').checked;
    let nights = 0;
    if(isStay) {
        const start = new Date(document.getElementById('t-time').value.split('T')[0]);
        const end = new Date(document.getElementById('t-stayEnd').value);
        nights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
    }

    const t = {
        id: Date.now().toString(),
        studentId: document.getElementById('t-sid').value,
        type: document.getElementById('t-type').value,
        time: document.getElementById('t-time').value,
        loc: document.getElementById('t-loc').value,
        info: document.getElementById('t-info').value,
        isStay: isStay,
        stayEnd: document.getElementById('t-stayEnd').value,
        nights: nights,
        hname: document.getElementById('t-hname')?.value || '',
        hcontact: document.getElementById('t-hcontact')?.value || '',
        transNet: document.getElementById('t-transNet').value,
        transGross: document.getElementById('t-transGross').value,
        stayNet: document.getElementById('t-stayNet').value,
        stayGross: document.getElementById('t-stayGross').value,
        status: 'todo'
    };
    transports.push(t);

    // è¯å‹•åŠŸèƒ½ï¼šå¯«å…¥äº’å‹•ç´€éŒ„
    if(document.getElementById('t-syncInter').checked) {
        const s = students.find(x => x.id === t.studentId);
        interactions.push({
            id: Date.now().toString() + 'i',
            studentId: t.studentId,
            date: t.time.split('T')[0],
            type: 'ç”Ÿæ´»',
            content: `ã€è¡Œç¨‹é ç´„ã€‘${t.type}ï¼š${t.loc}ã€‚${isStay ? 'å«ä½å®¿ '+nights+' æ™š ('+t.hname+')' : ''}`
        });
    }

    save();
    closeModal();
}

function updateTrStatus(id, newStatus) {
    const t = transports.find(x => x.id === id);
    if(t) {
        // å¦‚æœç‹€æ…‹æ”¹ç‚ºå®Œæˆï¼Œè©¢å•æ˜¯å¦æ‰£é™¤é›¶ç”¨éŒ¢
        if(newStatus === 'done' && t.status !== 'done') {
            const totalGross = (parseFloat(t.transGross)||0) + ((parseFloat(t.stayGross)||0) * (parseInt(t.nights)||0));
            if(confirm(`ä»»å‹™å®Œæˆï¼æ˜¯å¦è‡ªå‹•å¾é›¶ç”¨éŒ¢æ‰£é™¤å ±åƒ¹ç¸½é¡ Â£${totalGross}ï¼Ÿ`)) {
                const s = students.find(x => x.id === t.studentId);
                if(s) {
                    s.balance -= totalGross;
                    pocketMoney.push({
                        id: Date.now().toString() + 'p',
                        studentId: t.studentId,
                        date: new Date().toISOString().split('T')[0],
                        amount: -totalGross,
                        desc: `è¡Œç¨‹æ‰£è²»: ${t.type} @ ${t.loc}`
                    });
                }
            }
        }
        t.status = newStatus;
        save();
    }
}

function copyTrMsg(id) {
    const t = transports.find(x => x.id === id);
    const s = students.find(x => x.id === t.studentId);
    let msg = `ã€æ¥é€è¡Œç¨‹ç¢ºèªã€‘\nå­¸ç”Ÿï¼š${s.name}\nä»»å‹™ï¼š${t.type}\næ™‚é–“ï¼š${t.time.replace('T',' ')}\nç›®çš„åœ°ï¼š${t.loc}\nè³‡è¨Šï¼š${t.info}`;
    if(t.isStay) {
        msg += `\n---\nä½å®¿å®¶åº­ï¼š${t.hname}\nä½å®¶é›»è©±ï¼š${t.hcontact}\né€€æˆ¿æ—¥æœŸï¼š${t.stayEnd}\n(å…± ${t.nights} æ™š)`;
    }
    msg += `\n\n* è«‹æå‰15åˆ†é˜åˆ°é”ï¼Œè«‹å­¸ç”Ÿæª¢æŸ¥è­·ç…§åŠç§äººè¡Œæã€‚`;
    
    navigator.clipboard.writeText(msg).then(() => alert('è¨Šæ¯å·²è¤‡è£½ï¼Œå¯ç›´æ¥è²¼ä¸Š WhatsApp'));
}

// --- é€šç”¨æ¸²æŸ“é‚è¼¯ ---
function render() {
    // å­¸ç”Ÿæ¸…å–®
    const slist = document.getElementById('student-list');
    slist.innerHTML = students.map(s => `
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <b>${s.name} ${s.med ? '<span class="pill pill-med">ğŸ’Š</span>' : ''}</b>
                <span class="${s.balance < 300 ? 'balance-red' : ''}">Â£${s.balance.toFixed(2)}</span>
            </div>
            <div style="font-size:12px; color:gray; margin-top:5px;">
                ğŸ“ çˆ¶æ¯: ${s.parent || '-'} | ğŸ  å®¿ç®¡: ${s.house || '-'}<br>
                ğŸ“ ${s.addr || 'ç„¡åœ°å€è³‡è¨Š'}
            </div>
        </div>
    `).join('');

    // æ¥é€æ¸…å–®èˆ‡å°å¸³
    const mFilter = document.getElementById('transport-month-filter').value;
    const ongoing = transports.filter(t => t.status !== 'done');
    let history = transports.filter(t => t.status === 'done');
    
    let totalNet = 0, totalGross = 0;
    if(mFilter) {
        history = history.filter(t => t.time.startsWith(mFilter));
        history.forEach(t => {
            const n = (parseFloat(t.transNet)||0) + ((parseFloat(t.stayNet)||0) * (parseInt(t.nights)||0));
            const g = (parseFloat(t.transGross)||0) + ((parseFloat(t.stayGross)||0) * (parseInt(t.nights)||0));
            totalNet += n; totalGross += g;
        });
    }

    const trRow = (t) => {
        const s = students.find(x => x.id === t.studentId) || {name:'-'};
        const n = (parseFloat(t.transNet)||0) + ((parseFloat(t.stayNet)||0) * (parseInt(t.nights)||0));
        const g = (parseFloat(t.transGross)||0) + ((parseFloat(t.stayGross)||0) * (parseInt(t.nights)||0));
        return `<tr>
            <td><small>${t.time.replace('T',' ')}</small><br><b>${t.type}</b></td>
            <td>${s.name}<br><small>${t.loc}</small></td>
            <td>G: Â£${g}<br><small style="color:gray;">(N: Â£${n})</small></td>
            <td><select onchange="updateTrStatus('${t.id}', this.value)" class="status-badge status-${t.status}">
                <option value="todo" ${t.status==='todo'?'selected':''}>å¾…è¾¦</option>
                <option value="doing" ${t.status==='doing'?'selected':''}>é ç´„</option>
                <option value="done" ${t.status==='done'?'selected':''}>å®Œæˆ</option>
            </select></td>
            <td><button class="btn btn-mini btn-success" onclick="copyTrMsg('${t.id}')">ğŸ“‹</button></td>
        </tr>`;
    };

    document.getElementById('transport-active-list').innerHTML = `<table><tr><th>ä»»å‹™</th><th>å­¸ç”Ÿ</th><th>å¸³ç›®</th><th>ç‹€æ…‹</th><th>é€šçŸ¥</th></tr>` + ongoing.map(trRow).join('') + `</table>`;
    
    const summaryHtml = !mFilter ? '' : `
        <div class="summary-bar">
            <div><small>ç¸½æˆæœ¬</small><br><b style="color:var(--danger)">Â£${totalNet.toFixed(2)}</b></div>
            <div><small>ç¸½å ±åƒ¹</small><br><b style="color:var(--success)">Â£${totalGross.toFixed(2)}</b></div>
            <div><small>æ·¨åˆ©</small><br><b style="color:var(--primary)">Â£${(totalGross-totalNet).toFixed(2)}</b></div>
        </div>`;
    document.getElementById('transport-history-list').innerHTML = summaryHtml + `<table><tr><th>ä»»å‹™</th><th>å­¸ç”Ÿ</th><th>å¸³ç›®</th><th>ç‹€æ…‹</th><th>é€šçŸ¥</th></tr>` + history.map(trRow).join('') + `</table>`;

    // äº’å‹•èˆ‡é›¶ç”¨éŒ¢ (å¿«é€Ÿç°¡æ˜“ç‰ˆ)
    renderInteractions();
    renderPocket();
    
    // æ›´æ–° Filter ä¸‹æ‹‰é¸å–®
    const filters = students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    document.getElementById('inter-student-filter').innerHTML = '<option value="all">æ‰€æœ‰å­¸ç”Ÿ</option>' + filters;
    document.getElementById('pocket-student-filter').innerHTML = '<option value="all">æ‰€æœ‰å­¸ç”Ÿ</option>' + filters;
}

function renderInteractions() {
    const filter = document.getElementById('inter-student-filter').value;
    const list = document.getElementById('interaction-list');
    let data = interactions;
    if(filter !== 'all') data = data.filter(i => i.studentId === filter);
    list.innerHTML = data.sort((a,b)=>b.date.localeCompare(a.date)).map(i => `
        <div class="card"><small>${i.date} [${i.type}]</small><br>${i.content}</div>
    `).join('');
}

function renderPocket() {
    const filter = document.getElementById('pocket-student-filter').value;
    const list = document.getElementById('pocket-list');
    let data = pocketMoney;
    if(filter !== 'all') data = data.filter(p => p.studentId === filter);
    list.innerHTML = data.sort((a,b)=>b.date.localeCompare(a.date)).map(p => `
        <div class="card" style="display:flex; justify-content:space-between;">
            <span><small>${p.date}</small><br>${p.desc}</span>
            <b style="color:${p.amount<0? 'red':'green'}">${p.amount<0?'':'+'}Â£${p.amount}</b>
        </div>
    `).join('');
}

function closeModal() { document.getElementById('modal').style.display = 'none'; }

// åˆå§‹åŒ–
window.onload = render;
</script>

</body>
</html>
