<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyNest 學生管理資料庫 - Firebase 雲端版</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: #333;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: none; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-box {
            background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2); text-align: center; max-width: 400px; width: 100%;
        }
        .login-box h1 { margin-bottom: 25px; color: #4a4a4a; }
        .login-box input {
            width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd;
            border-radius: 10px; font-size: 16px; outline: none;
        }
        .login-box button {
            width: 100%; padding: 12px; background: #667eea; border: none;
            border-radius: 10px; color: white; font-size: 16px; cursor: pointer; transition: 0.3s;
        }
        .login-box button:hover { background: #5a67d8; }
        
        .header {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            padding: 20px; border-radius: 15px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab {
            padding: 10px 25px; background: rgba(255, 255, 255, 0.5);
            border-radius: 10px; cursor: pointer; transition: 0.3s; font-weight: bold;
        }
        .tab.active { background: white; color: #667eea; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;
        }
        .card {
            background: white; border-radius: 15px; padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: 0.3s; position: relative;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15); }
        .student-photo {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            margin-bottom: 15px; border: 3px solid #667eea;
        }
        .btn {
            padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer;
            transition: 0.2s; font-weight: bold; margin: 2px;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #ff4d4d; color: white; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 1000;
        }
        .modal-content {
            background: white; width: 90%; max-width: 600px; margin: 50px auto;
            border-radius: 15px; padding: 30px; max-height: 80vh; overflow-y: auto;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;
        }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 15px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #667eea; }
    </style>
</head>
<body>

    <div id="login-screen" class="login-container">
        <div class="login-box">
            <h1>StudyNest Admin</h1>
            <input type="password" id="admin-password" placeholder="請輸入管理員密碼">
            <button onclick="login()">進入系統</button>
        </div>
    </div>

    <div id="main-container" class="container">
        <div class="header">
            <h2>StudyNest 學生管理系統 (London Cloud)</h2>
            <div class="user-info">
                <span id="sync-status">雲端同步中...</span>
                <button class="btn btn-danger" onclick="logout()">退出</button>
            </div>
        </div>

        <div class="nav-tabs">
            <div class="tab active" onclick="switchTab('students')">學生名單</div>
            <div class="tab" onclick="switchTab('interactions')">互動記錄</div>
            <div class="tab" onclick="switchTab('money')">零用錢管理</div>
        </div>

        <section id="students-section" class="content-section active">
            <div class="header" style="background: white; margin-bottom: 15px;">
                <input type="text" id="student-search" placeholder="搜尋學生姓名..." style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 300px;">
                <button class="btn btn-primary" onclick="openModal('student-modal')">+ 新增學生</button>
            </div>
            <div id="student-list" class="card-grid"></div>
        </section>

        <section id="interactions-section" class="content-section">
            <div class="header" style="background: white; margin-bottom: 15px;">
                <input type="text" id="interaction-search" placeholder="搜尋記錄..." style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 300px;">
                <button class="btn btn-primary" onclick="openInteractionModal()">+ 新增記錄</button>
            </div>
            <div id="interaction-list"></div>
        </section>

        <section id="money-section" class="content-section">
            <div class="header" style="background: white; margin-bottom: 15px;">
                <input type="text" id="money-search" placeholder="搜尋帳目..." style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 300px;">
                <button class="btn btn-primary" onclick="openMoneyModal()">+ 新增帳目</button>
            </div>
            <div id="money-list"></div>
        </section>
    </div>

    <div id="student-modal" class="modal">
        <div class="modal-content">
            <h3>學生資料</h3>
            <form id="student-form">
                <input type="hidden" id="edit-student-id">
                <div class="form-group">
                    <label>照片預覽</label>
                    <img id="photo-preview" src="https://via.placeholder.com/80" class="student-photo">
                    <input type="file" id="student-photo-input" accept="image/*" onchange="previewImage(this)">
                </div>
                <div class="form-group"><label>姓名</label><input type="text" id="student-name" required></div>
                <div class="form-group"><label>生日</label><input type="date" id="student-birthday"></div>
                <div class="form-group"><label>就讀學校</label><input type="text" id="student-school"></div>
                <div class="form-group"><label>年級</label><input type="text" id="student-grade"></div>
                <div class="form-group"><label>家長姓名</label><input type="text" id="parent-name"></div>
                <div class="form-group"><label>聯絡電話</label><input type="text" id="parent-phone"></div>
                <div class="form-group"><label>備註</label><textarea id="student-notes"></textarea></div>
                <button type="submit" class="btn btn-primary">儲存資料到雲端</button>
                <button type="button" class="btn" onclick="closeModal('student-modal')">取消</button>
            </form>
        </div>
    </div>

    <div id="interaction-modal" class="modal">
        <div class="modal-content">
            <h3>新增互動記錄</h3>
            <form id="interaction-form">
                <div class="form-group">
                    <label>選擇學生</label>
                    <select id="interaction-student-select" required></select>
                </div>
                <div class="form-group"><label>日期</label><input type="date" id="interaction-date" required></div>
                <div class="form-group">
                    <label>類型</label>
                    <select id="interaction-type">
                        <option value="面談">面談</option>
                        <option value="電話">電話</option>
                        <option value="課程">課程</option>
                    </select>
                </div>
                <div class="form-group"><label>內容</label><textarea id="interaction-content" required></textarea></div>
                <button type="submit" class="btn btn-primary">提交</button>
                <button type="button" class="btn" onclick="closeModal('interaction-modal')">取消</button>
            </form>
        </div>
    </div>

    <div id="money-modal" class="modal">
        <div class="modal-content">
            <h3>新增零用錢帳目</h3>
            <form id="money-form">
                <div class="form-group">
                    <label>選擇學生</label>
                    <select id="money-student-select" required></select>
                </div>
                <div class="form-group"><label>日期</label><input type="date" id="money-date" required></div>
                <div class="form-group">
                    <label>類型</label>
                    <select id="money-type">
                        <option value="收入">收入 (學生拿到錢)</option>
                        <option value="支出">支出 (學生花錢)</option>
                    </select>
                </div>
                <div class="form-group"><label>金額</label><input type="number" id="money-amount" step="0.01" required></div>
                <div class="form-group"><label>原因</label><input type="text" id="money-reason"></div>
                <button type="submit" class="btn btn-primary">儲存</button>
                <button type="button" class="btn" onclick="closeModal('money-modal')">取消</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, getDocs, onSnapshot, 
            doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase 配置 (已填入你的資料)
        const firebaseConfig = {
          apiKey: "AIzaSyAKX54sBQ8xu9C6hn-Az7XOcmRCjkOOht4",
          authDomain: "studynest-database.firebaseapp.com",
          projectId: "studynest-database",
          storageBucket: "studynest-database.firebasestorage.app",
          messagingSenderId: "193833641970",
          appId: "1:193833641970:web:e2063f85f52c4bc891ed6b",
          measurementId: "G-ZD4FXDYHF9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 資料狀態
        let studentsData = [];
        let interactions = [];
        let moneyRecords = [];

        // --- 初始化與同步 ---
        function startSync() {
            // 同步學生
            onSnapshot(collection(db, "students"), (snapshot) => {
                studentsData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updateDisplay();
                updateSelects();
            });
            // 同步記錄
            onSnapshot(query(collection(db, "interactions"), orderBy("date", "desc")), (snapshot) => {
                interactions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updateDisplay();
            });
            // 同步零用錢
            onSnapshot(query(collection(db, "moneyRecords"), orderBy("date", "desc")), (snapshot) => {
                moneyRecords = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updateDisplay();
            });
        }

        // --- 核心功能函數 ---
        window.addStudent = async function(e) {
            e.preventDefault();
            const editId = document.getElementById('edit-student-id').value;
            const data = {
                name: document.getElementById('student-name').value,
                birthday: document.getElementById('student-birthday').value,
                school: document.getElementById('student-school').value,
                grade: document.getElementById('student-grade').value,
                parentName: document.getElementById('parent-name').value,
                parentPhone: document.getElementById('parent-phone').value,
                notes: document.getElementById('student-notes').value,
                photo: document.getElementById('photo-preview').src,
                updatedAt: serverTimestamp()
            };

            try {
                if (editId) {
                    await updateDoc(doc(db, "students", editId), data);
                } else {
                    await addDoc(collection(db, "students"), data);
                }
                closeModal('student-modal');
                document.getElementById('student-form').reset();
            } catch (err) { alert("儲存失敗: " + err.message); }
        };

        window.deleteStudent = async function(id) {
            if(confirm("確定刪除此學生及其所有雲端記錄嗎？")) {
                await deleteDoc(doc(db, "students", id));
            }
        };

        window.addInteraction = async function(e) {
            e.preventDefault();
            const data = {
                studentId: document.getElementById('interaction-student-select').value,
                date: document.getElementById('interaction-date').value,
                type: document.getElementById('interaction-type').value,
                content: document.getElementById('interaction-content').value
            };
            await addDoc(collection(db, "interactions"), data);
            closeModal('interaction-modal');
        };

        window.addMoneyRecord = async function(e) {
            e.preventDefault();
            const data = {
                studentId: document.getElementById('money-student-select').value,
                date: document.getElementById('money-date').value,
                type: document.getElementById('money-type').value,
                amount: parseFloat(document.getElementById('money-amount').value),
                reason: document.getElementById('money-reason').value
            };
            await addDoc(collection(db, "moneyRecords"), data);
            closeModal('money-modal');
        };

        // --- UI 輔助功能 ---
        window.updateDisplay = function() {
            const list = document.getElementById('student-list');
            list.innerHTML = studentsData.map(s => `
                <div class="card">
                    <img src="${s.photo || 'https://via.placeholder.com/80'}" class="student-photo">
                    <h4>${s.name}</h4>
                    <p><small>${s.school} - ${s.grade}</small></p>
                    <div style="margin-top:10px;">
                        <button class="btn btn-primary" onclick="editStudent('${s.id}')">編輯</button>
                        <button class="btn btn-danger" onclick="deleteStudent('${s.id}')">刪除</button>
                    </div>
                </div>
            `).join('');

            // 更新互動清單
            const intList = document.getElementById('interaction-list');
            intList.innerHTML = `<table><tr><th>日期</th><th>學生</th><th>類型</th><th>內容</th></tr>` + 
                interactions.map(i => {
                    const s = studentsData.find(st => st.id === i.studentId);
                    return `<tr><td>${i.date}</td><td>${s ? s.name : '未知'}</td><td>${i.type}</td><td>${i.content}</td></tr>`;
                }).join('') + `</table>`;
        };

        window.updateSelects = function() {
            const selects = ['interaction-student-select', 'money-student-select'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = studentsData.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            });
        };

        window.editStudent = function(id) {
            const s = studentsData.find(st => st.id === id);
            if(s) {
                document.getElementById('edit-student-id').value = s.id;
                document.getElementById('student-name').value = s.name;
                document.getElementById('photo-preview').src = s.photo;
                openModal('student-modal');
            }
        };

        // --- 基礎框架功能 ---
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab, .content-section').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab[onclick*="${tab}"]`).classList.add('active');
            document.getElementById(`${tab}-section`).classList.add('active');
        };

        window.openModal = (id) => document.getElementById(id).style.display = 'block';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        window.login = function() {
            if(document.getElementById('admin-password').value === '1234') { // 預設密碼 1234
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-container').style.display = 'block';
                startSync();
            } else { alert('密碼錯誤'); }
        };

        window.previewImage = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => document.getElementById('photo-preview').src = e.target.result;
                reader.readAsDataURL(input.files[0]);
            }
        };

        // 綁定事件
        document.getElementById('student-form').addEventListener('submit', addStudent);
        document.getElementById('interaction-form').addEventListener('submit', addInteraction);
        document.getElementById('money-form').addEventListener('submit', addMoneyRecord);
    </script>
</body>
</html>
