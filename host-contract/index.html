<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>StudyNest Education Host Agreement</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Dancing+Script:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Calibri', 'Noto Sans SC', sans-serif;
            line-height: 1.4;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-size: 14px;
        }
        
        .chinese-text, [lang="zh"] {
            font-family: 'Noto Sans SC', 'Microsoft YaHei', '微軟雅黑', sans-serif;
        }
        
        .english-text, [lang="en"] {
            font-family: 'Calibri', 'Times New Roman', serif;
        }
        
        .contract-container {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .letterhead {
            background: linear-gradient(135deg, #2c5282 0%, #2d3748 50%, #1a365d 100%);
            color: white;
            padding: 20px 40px;
            text-align: center;
            position: relative;
        }
        
        .letterhead::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(237, 137, 54, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(56, 178, 172, 0.1) 0%, transparent 50%);
            opacity: 0.6;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }
        
        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #a2a8bd 0%, #8792a8 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .logo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 50%);
            border-radius: 50%;
        }
        
        .nest-logo {
            width: 35px;
            height: 35px;
            position: relative;
        }
        
        /* Create the nest bowl shape */
        .nest-bowl {
            width: 22px;
            height: 12px;
            border: 2px solid #ed8936;
            border-top: none;
            border-radius: 0 0 12px 12px;
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .nest-bowl::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 2px;
            background: #ed8936;
            top: -1px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 1px;
        }
        
        .nest-bowl::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 1px;
            background: #ed8936;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 1px;
        }
        
        /* Create the leaf */
        .nest-leaf {
            width: 6px;
            height: 10px;
            background: #38b2ac;
            border-radius: 0 100% 0 100%;
            position: absolute;
            top: 4px;
            left: 50%;
            transform: translateX(-50%) rotate(15deg);
        }
        
        /* Create the book */
        .nest-book {
            width: 18px;
            height: 4px;
            background: #2b6cb0;
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 1px;
        }
        
        .nest-book::before {
            content: '';
            position: absolute;
            width: 15px;
            height: 3px;
            background: #3182ce;
            top: -2px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 1px;
        }
        
        .title-section {
            text-align: left;
            flex-grow: 1;
        }

        .letterhead h1 {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            letter-spacing: 0.5px;
            color: white;
        }
        
        .letterhead .chinese-title {
            font-size: 1.3em;
            font-weight: 600;
            position: relative;
            z-index: 1;
            margin-bottom: 0;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        }
        
        .letterhead .contact-info {
            margin-top: 10px;
            font-size: 0.95em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            font-weight: 400;
            text-align: center;
        }
        
        .contact-info a {
            color: #f6ad55;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .contact-info a:hover {
            color: #ed8936;
            text-shadow: 0 0 8px rgba(237, 137, 54, 0.5);
        }
        
        .contract-content {
            padding: 30px;
        }
        
        .review-date {
            text-align: right;
            margin-bottom: 30px;
            font-style: italic;
            color: #666;
        }
        
        h1, h2, h3 {
            color: #2d3748;
            margin: 20px 0 15px 0;
        }
        
        h1 {
            font-size: 1.6em;
            border-bottom: 3px solid #ed8936;
            padding-bottom: 10px;
        }
        
        h2 {
            font-size: 1.3em;
            color: #2c5282;
        }
        
        h3 {
            font-size: 1.1em;
            color: #2d3748;
        }
        
        .parties-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border: 2px solid #ddd;
        }
        
        .parties-table td, .parties-table th {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
            vertical-align: middle;
        }
        
        .parties-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .input-field {
            width: 100%;
            padding: 6px 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-family: inherit;
            font-size: 13px;
            transition: border-color 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: background-color 0.3s ease;
            font-size: 13px;
        }
        
        .checkbox-group:hover {
            background: #e9ecef;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
            accent-color: #667eea;
        }
        
        .service-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            border: 2px solid #ddd;
            font-size: 12px;
        }
        
        .service-table th, .service-table td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }
        
        .service-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }
        
        .service-table .check-mark {
            text-align: center;
            font-size: 1.2em;
            color: #28a745;
        }
        
        .signature-section {
            margin: 40px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #667eea;
        }
        
        .signature-pad {
            width: 100%;
            height: 120px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            background: white;
            cursor: crosshair;
            display: block;
            touch-action: none;
        }
        
        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .final-actions {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 20px;
            border-top: 3px solid #667eea;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        
        .medical-form {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
        }
        
        .fees-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .validation-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1) !important;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .signature-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
        }

        .signature-status.signed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .signature-status.empty {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        @media print {
            .final-actions {
                display: none;
            }
            
            .contract-container {
                box-shadow: none;
                margin: 0;
            }
            
            body {
                background: white;
            }
        }
        
        .elegant-signature {
            font-family: 'Dancing Script', cursive;
            font-size: 2.2em;
            font-weight: 600;
            color: #2c5282;
            text-align: center;
            margin: 10px 0;
            transform: rotate(-2deg);
        }
        
        .chinese-text {
            font-family: 'Noto Sans SC', sans-serif;
            font-weight: 400;
        }
</style>
</head>
<body>
<div class="contract-container">
<div class="letterhead">
<div class="logo-container">
<div class="logo" style="width: 100px; height: 100px; background: rgba(255, 255, 255, 0.5);">
<img alt="StudyNest Education Logo" src="StudyNest Education.png" style="width: 65px; height: 65px; object-fit: contain;"/>
</div>
<div class="title-section">
<h1>StudyNest Education</h1>
</div>
</div>
</div>
<div class="contract-content">
<div class="review-date">
<strong>Review Date：August 2025</strong>
</div>
<h1 style="text-align: center;">Short-Term Host Family Agreement</h1>
<h2>Agreement Parties</h2>
<table class="parties-table">
<tr>
<th style="width: 20%;">
<div style="font-size: 0.9em; line-height: 1.3;">
<div><strong>Party A:</strong></div>
</div>
</th>
<td style="width: 40%;">
<input class="input-field" id="parentName" placeholder="Host Family Representative" required="" type="text"/>
</td>
<td style="width: 40%; font-size: 0.85em; line-height: 1.4;">
<div>(hereinafter referred to as <strong>the Host</strong>)</div>
</td>
</tr>
<tr>
<td style="font-size: 0.9em; line-height: 1.3;">
<div><strong>Address:</strong></div>
</td>
<td colspan="2">
<textarea class="input-field" id="parentAddress" placeholder="Please enter full address" required="" rows="3"></textarea>
</td>
</tr>
<tr>
<th style="font-size: 0.9em; line-height: 1.3;">
<div><strong>Party B:</strong></div>
</th>
<td><strong>StudyNest Education Limited</strong></td>
<td style="font-size: 0.85em; line-height: 1.4;">
<div>(hereinafter referred to as <strong>StudyNest</strong> or <strong>the Company</strong>)</div>
</td>
</tr>
<tr>
<td style="font-size: 0.9em; line-height: 1.3;">
<div><strong>Address:</strong></div>
</td>
<td colspan="2"><strong>1 Boleyn Way, Barnet, EN5 5LH</strong></td>
</tr>
<tr>
<td style="font-size: 0.9em; line-height: 1.3;">
<div><strong>Contract No.:</strong></div>
</td>
<td colspan="2">
<input class="input-field" id="contractNumberInput" placeholder="Contract number will be auto-generated" readonly="" style="background-color: #f8f9fa; color: #6c757d;" type="text"/>
</td>
</tr>
<tr>
<td style="font-size: 0.9em; line-height: 1.3;">
<div><strong>Date of Signing:</strong></div>
</td>
<td colspan="2">
<input class="input-field" id="signingDate" readonly="" required="" type="date"/>
</td>
</tr>
</table>
<p>By signing this Agreement, both parties agree to abide by the following terms and conditions, including the appended Host Family Responsibilities and Legal Provisions.</p>

<h2>Purpose and Scope</h2>
<div style="padding-left: 20px;">
<p>This Agreement governs the provision of short-term accommodation to students under the care of StudyNest Education Ltd. Placements may include weekends, half-terms, exeats, or emergency situations.</span></p>
<p>The primary aim is to ensure:</span></p>
        <ul style="margin-left: 40px;">
<li>Student welfare and safeguarding at all times</span></li>
<li>A safe, clean, and appropriate hosting environment</span></li>
<li>Clarity regarding responsibilities, expectations, and conduct</span></li>
</div>

<h2>Booking Process</h2>
<div style="padding-left: 20px;">
<p>All placements are coordinated exclusively by StudyNest Education Ltd.</span></p>
<p>Hosts will be contacted with student details, stay dates, and special requirements.</span></p>
<p>Hosts must respond to confirm availability within 24 hours.</span></p>
<p>The Company reserves the right to reallocate students if timely confirmation is not received.</span></p>
</ul>
</div>

<h2>Host Responsibilities</h2>
<div style="padding-left: 20px;">
<p>The Host Family agrees to:</span></p>
<p><strong>a) </strong> Provide a clean, safe home environment with appropriate facilities</span></p>
<p><strong>b) </strong> Offer a private bedroom (not shared with any family member)</span></p>
<p><strong>c) </strong> Supply three daily meals unless otherwise agreed</span></p>
<p><strong>d) </strong> Supervise the student appropriately and ensure they are never left overnight without an adult</span></p>
<p><strong>e) </strong> Maintain open communication with the Company and promptly report any issues or concerns</span></p>
<p>Students must not:</span></p>
<p><strong>a) </strong> Stay overnight elsewhere without prior written approval from the Company</span></p>
<p><strong>b) </strong> Be left unsupervised overnight under any circumstance</span></p>
<p>If a key is not provided, a responsible adult must be present to allow entry at expected times.</span></p>
</ul>
</div>

<h2>Host Responsibilities</h2>
<div style="padding-left: 20px;">
<p>All residents aged 16+ must undergo enhanced DBS checks.</span></p>
<p>The Host agrees to comply with the Company’s safeguarding policy at all times.</span></p>
<p>Any safeguarding concern must be reported immediately to the Company.</span></p>
<p><strong>Safeguarding Contacts:<strong></span></p>
<p> DSL: Jessie Chang info@studynest.uk </span></p>
</ul>
</div>

<h2>Payments</h2>
<div style="padding-left: 20px;">
<p>Hosts will be paid the agreed nightly rate by bank transfer within 7 working days following the end of the placement.</span></p>
<p>The Company is not liable for reimbursement of incidental expenses (e.g., transportation, entertainment, personal items).</span></p>
</ul>
</div>   

<h2>Cancellations</h2>
<div style="padding-left: 20px;">
<p>If StudyNest cancels a confirmed booking within one week (7 days) prior to the scheduled arrival date, a goodwill cancellation fee of £50 per week of the confirmed booking will be paid to the Host, up to a maximum of £100.</span></p>
<p>No cancellation fee will be payable if cancellation is made more than one week prior to the scheduled arrival.</span></p>
<p>Repeated or unreasonably late cancellations by the Host may result in temporary suspension or removal from the approved host list, at the discretion of StudyNest Education.</span></p>
</ul>
</div>   

<h2>Private Arrangements</h2>
<div style="padding-left: 20px;">
<p>Hosts may not enter into direct or private agreements with students or their families.</span></p>
<p>All placements must be made through StudyNest Education Ltd.</span></p>
<p>Breach of this clause will result in immediate termination and potential legal action.</span></p>
</ul>
</div>   

<h2>Termination</h2>
<div style="padding-left: 20px;">
<p>Either party may terminate this Agreement with 14 days' written notice.</span></p>
<p>The Company reserves the right to terminate the agreement immediately in the event of any safeguarding concern, misconduct, or breach of contract.</span></p>
</ul>
</div>   

<h2>Host Family Responsibilities</h2>
<div style="padding-left: 20px;">
<p>The Host must:</span></p>
<p><strong>1. </strong> Submit enhanced DBS checks (covered by the Company)</span></p>
<p><strong>2. </strong> Subscribe to the DBS Update Service and maintain validity</span></p>
<p><strong>3. </strong> Complete annual safeguarding training (online)</span></p>
<p><strong>4. </strong> Submit a signed medical declaration</span></p>
<p><strong>5. </strong> Provide two character references (one professional)</span></p>
<p><strong>6. </strong> Cooperate with inspections by the Company, AEGIS, or other relevant authorities</span></p>
<p><strong>7. </strong> Provide:</span></p>
        <li>Private bed and study space</span></li>
        <li>Clean linens and towels weekly</span></li>
        <li>Heating, lighting, bathroom access</span></li>
        <li>Three meals daily and appropriate supervision</span></li>
<p><strong>8. </strong> Notify the Company of any changes to household members or conditions</span></p>
<p><strong>9. </strong> Refrain from making any private hosting arrangements with students or families</span></p>
<p><strong>10. </strong> Maintain emergency contact communication and assist students if needed</span></p>
</ul>
</div>

<h2>Legal Provisions</h2>
<div style="padding-left: 20px;">
<p><strong>Indemnity<strong></span></p>
<p>The Host agrees to indemnify StudyNest Education Ltd from all liabilities resulting from negligence, misconduct, or breach of contract.</span></p>
<p><strong>Insurance<strong></span></p>
<p>The Host must maintain appropriate home insurance including third-party liability.</span></p>
<p><strong>Confidentiality & Data Protection<strong></span></p>
<p>All student and Company information must be treated as confidential under GDPR and UK Data Protection Act 2018.</span></p>
<p><strong>Jurisdiction<strong></span></p>
<p>This Agreement is governed by the laws of England and Wales.</span></p>
<p><strong>Enforcement<strong></span></p>
<p>The attached job description and legal provisions form part of this binding agreement.</span></p>
</ul>
</div> 
        
<h2>Payment Information</h2>
<p>To ensure prompt and accurate payment following any short-term hosting arrangement, please provide your bank details below. This information will be used solely for the purpose of transferring agreed fees for completed placements.</p>

<h3>Bank Details</h3>
<table class="parties-table">
  <tr>
    <td style="width: 30%;"><strong>Account Name</strong></td>
    <td style="width: 30%;"><strong>Contact Number</strong></td>
  </tr>
  <tr>
    <td>
      <input type="text" name="accountName" id="accountName" class="input-field" placeholder="e.g. John Smith" />
    </td>
    <td>
      <input type="text" name="contactNumber" id="contactNumber" class="input-field" placeholder="e.g. 07123456789" />
    </td>
  </tr>
  <tr>
    <td style="width: 30%;"><strong>Sort Code</strong></td>
    <td style="width: 30%;"><strong>Account Number</strong></td>
  </tr>
  <tr>
    <td>
      <input type="text" name="sortCode" id="sortCode" class="input-field" placeholder="e.g. 12-34-56" />
    </td>
    <td>
      <input type="text" name="accountNumber" id="accountNumber" class="input-field" placeholder="e.g. 12345678" />
    </td>
  </tr>
</table>

<div style="margin: 30px 0; padding: 20px; background: #f0f8ff; border-radius: 10px; border-left: 5px solid #ed8936;">
<h4 style="color: #2d3748;">Declaration </h4>
<p>By signing this Agreement, both parties agree to abide by the following terms and conditions, including the appended Host Family Responsibilities and Legal Provisions.</p>
</div>

<div class="signature-section">
<h4>Host Signature</h4>
<canvas class="signature-pad" id="fatherSignature"></canvas>
<div class="signature-controls">
<button class="btn btn-secondary" onclick="clearSignature('fatherSignature')" type="button"> Clear</button>
</div>
<input class="input-field" id="fatherSignatureDate" placeholder="簽名日期 Signature Date" style="margin-top: 10px;" type="text"/>
<div class="signature-status empty">⚠ Please complete signature</div>
</div>
<div class="signature-section">
<div class="signature-section">
<h4>StudyNest Education 代表簽名</h4>
<div style="text-align: center; padding: 20px; background: white; border: 2px solid #ddd; border-radius: 8px;">
<div class="elegant-signature">Jessie Chang</div>
<p><strong>StudyNest Education Representative</strong></p>
<p>Date: <span id="companySignatureDate"></span></p>
</div>
<!-- 感谢文字 -->
<div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border-left: 5px solid #28a745; text-align: center;">
<h4 style="color: #28a745; margin-bottom: 15px; font-size: 1.2em;">✅ Contract Completion 合約完成</h4>
<p style="margin-bottom: 10px; line-height: 1.6;">
Thank you for completing the online contract. Your electronic signature has been recorded. To finalise the process, please <strong>download the signed PDF</strong> and <strong>return it to StudyNest Education</strong> for our records. No further signature is required.
</p>
</div>
</div>
<div class="final-actions">
<button class="btn btn-primary" onclick="printContract()" type="button">
                📄 Download Signed Contract
            </button>
</div>
</div>

<script>
// 檢查必要的外部庫是否已載入
function checkLibraries() {
    const missingLibs = [];
    
    if (typeof window.jspdf === 'undefined') {
        missingLibs.push('jsPDF');
    }
    
    if (typeof html2canvas === 'undefined') {
        missingLibs.push('html2canvas');
    }
    
    if (missingLibs.length > 0) {
        console.error('缺少必要的外部庫:', missingLibs.join(', '));
        return false;
    }
    
    return true;
}

// 電子簽名功能類
class SignaturePad {
    constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.isDrawing = false;
        this.hasSignature = false;
        this.lastPos = { x: 0, y: 0 };
        
        this.setupCanvas();
        this.attachEventListeners();
    }
    
    setupCanvas() {
        // 設置canvas尺寸
        const rect = this.canvas.getBoundingClientRect();
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        
        this.canvas.width = rect.width * ratio;
        this.canvas.height = rect.height * ratio;
        
        this.canvas.style.width = rect.width + 'px';
        this.canvas.style.height = rect.height + 'px';
        
        this.ctx.scale(ratio, ratio);
        
        // 設置繪製樣式
        this.ctx.strokeStyle = '#2c3e50';
        this.ctx.lineWidth = 2;
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        this.ctx.imageSmoothingEnabled = true;
    }
    
    attachEventListeners() {
        // 鼠標事件
        this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
        this.canvas.addEventListener('mousemove', (e) => this.draw(e));
        this.canvas.addEventListener('mouseup', () => this.stopDrawing());
        this.canvas.addEventListener('mouseout', () => this.stopDrawing());
        
        // 觸控事件
        this.canvas.addEventListener('touchstart', (e) => this.handleTouch(e));
        this.canvas.addEventListener('touchmove', (e) => this.handleTouch(e));
        this.canvas.addEventListener('touchend', () => this.stopDrawing());
        
        // 防止頁面滾動
        this.canvas.addEventListener('touchstart', (e) => e.preventDefault());
        this.canvas.addEventListener('touchmove', (e) => e.preventDefault());
    }
    
    getPosition(e) {
        const rect = this.canvas.getBoundingClientRect();
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
    }
    
    startDrawing(e) {
        this.isDrawing = true;
        this.lastPos = this.getPosition(e);
        
        // 開始新路徑
        this.ctx.beginPath();
        this.ctx.moveTo(this.lastPos.x, this.lastPos.y);
    }
    
    draw(e) {
        if (!this.isDrawing) return;
        
        const currentPos = this.getPosition(e);
        
        this.ctx.lineTo(currentPos.x, currentPos.y);
        this.ctx.stroke();
        
        this.lastPos = currentPos;
        this.hasSignature = true;
        this.updateStatus();
    }
    
    stopDrawing() {
        if (this.isDrawing) {
            this.isDrawing = false;
            this.ctx.beginPath(); // 結束當前路徑
        }
    }
    
    handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent(
            e.type === 'touchstart' ? 'mousedown' : 'mousemove',
            {
                clientX: touch.clientX,
                clientY: touch.clientY
            }
        );
        this.canvas.dispatchEvent(mouseEvent);
    }
    
    clear() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.hasSignature = false;
        this.updateStatus();
    }
    
    isEmpty() {
        return !this.hasSignature;
    }
    
    getDataURL(type = 'image/png') {
        return this.canvas.toDataURL(type);
    }
    
    updateStatus() {
        const statusEl = this.canvas.parentElement.querySelector('.signature-status');
        if (statusEl) {
            if (this.hasSignature) {
                statusEl.className = 'signature-status signed';
                statusEl.textContent = '✓ 簽名已完成 Signature completed';
            } else {
                statusEl.className = 'signature-status empty';
                statusEl.textContent = '⚠ 請完成簽名 Please complete signature';
            }
        }
    }
}

// PDF生成和下載功能類
class ContractPDFGenerator {
    constructor() {
        this.signatures = {};
    }
    
    // 初始化所有簽名板
    initializeSignaturePads() {
        const signatureCanvases = document.querySelectorAll('.signature-pad');
        
        signatureCanvases.forEach(canvas => {
            this.signatures[canvas.id] = new SignaturePad(canvas);
            
            // 添加狀態顯示元素
            if (!canvas.parentElement.querySelector('.signature-status')) {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'signature-status empty';
                statusDiv.textContent = '⚠ 請完成簽名 Please complete signature';
                canvas.parentElement.appendChild(statusDiv);
            }
        });
    }
    
    // 清除指定簽名
    clearSignature(canvasId) {
        if (this.signatures[canvasId]) {
            this.signatures[canvasId].clear();
        }
    }
    

    
    // 生成合約編號
function generateContractNumber() {
    try {
        const hostNameEl = document.getElementById('parentName');

        if (!hostNameEl) {
            console.warn('合約編號生成：找不到 Host Family Representative 欄位');
            return 'HOST-PENDING-COMPLETION';
        }

        const hostNameRaw = hostNameEl.value?.trim() || '';

        if (hostNameRaw) {
            // 移除特殊字元與多餘空格，保證合約編號格式乾淨
            const hostNameSanitized = hostNameRaw.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '');
            const contractNumber = `HOST-${hostNameSanitized}-2025`;

            const contractNumberInput = document.getElementById('contractNumberInput');
            if (contractNumberInput) {
                contractNumberInput.value = contractNumber;
                contractNumberInput.style.backgroundColor = '#e8f5e8';
                contractNumberInput.style.color = '#2d5a2d';
            } else {
                console.warn('contractNumberInput 元素未找到');
            }

            return contractNumber;
        }

        return 'HOST-PENDING-COMPLETION';
    } catch (error) {
        console.error('生成合約編號時發生錯誤:', error);
        return 'HOST-PENDING-COMPLETION';
    }
}
    
    // 生成並下載PDF
    async generatePDF() {
        try {
            // 檢查外部庫
            if (!checkLibraries()) {
                alert('系統載入中，請稍後再試...\nSystem loading, please try again later...');
                return;
            }
            
            // 驗證表單
            const validation = this.validateForm();
            if (!validation.isValid) {
                alert('請完成以下項目後再下載合約：\n\n' + validation.errors.join('\n'));
                return;
            }
            
            // 生成合約編號
            this.generateContractNumber();
            
            // 隱藏下載按鈕
            const finalActions = document.querySelector('.final-actions');
            if (finalActions) {
                finalActions.style.display = 'none';
            }
            
            // 顯示載入訊息
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'pdf-loading';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                font-family: inherit;
            `;
            loadingDiv.innerHTML = `
                <div style="font-size: 18px; margin-bottom: 15px;">📄 正在生成PDF合約...</div>
                <div style="font-size: 14px; color: #666;">Generating PDF contract...</div>
                <div style="margin-top: 15px;">
                    <div style="width: 200px; height: 4px; background: #f0f0f0; border-radius: 2px; overflow: hidden;">
                        <div style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 2px; animation: progress 3s ease-in-out infinite;"></div>
                    </div>
                </div>
                <style>
                    @keyframes progress {
                        0% { width: 0%; }
                        50% { width: 70%; }
                        100% { width: 100%; }
                    }
                </style>
            `;
            document.body.appendChild(loadingDiv);
            
            // 等待一點時間讓UI更新
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 使用html2canvas捕獲整個合約內容
            const contractContainer = document.querySelector('.contract-container');
            
            const canvas = await html2canvas(contractContainer, {
                scale: 2, // 高品質
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: contractContainer.offsetWidth,
                height: contractContainer.offsetHeight,
                scrollX: 0,
                scrollY: 0
            });
            
            // 創建PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // 計算圖片尺寸以適應A4
            const imgWidth = 210; // A4寬度
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            // 如果內容太長，分頁處理
            let heightLeft = imgHeight;
            let position = 0;
            
            // 添加第一頁
            pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= 297; // A4高度
            
            // 如果需要分頁
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= 297;
            }
            
            // 生成檔案名稱
            const contractNumber = this.generateContractNumber();
            const studentName = `${document.getElementById('studentFirstName').value}_${document.getElementById('studentLastName').value}`;
            const fileName = `StudyNest_Contract_${contractNumber}_${studentName}.pdf`;
            
            // 下載PDF
            pdf.save(fileName);
            
            // 移除載入訊息
            document.body.removeChild(loadingDiv);
            
            // 恢復下載按鈕
            if (finalActions) {
                finalActions.style.display = 'flex';
            }
            
            // 顯示成功訊息
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #d4edda;
                color: #155724;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-family: inherit;
                border: 1px solid #c3e6cb;
            `;
            successDiv.innerHTML = `
                <div style="font-weight: bold;">✅ PDF合約下載成功！</div>
                <div style="font-size: 12px; margin-top: 5px;">請將檔案回傳給StudyNest Education</div>
            `;
            document.body.appendChild(successDiv);
            
            // 3秒後移除成功訊息
            setTimeout(() => {
                if (document.body.contains(successDiv)) {
                    document.body.removeChild(successDiv);
                }
            }, 3000);
            
        } catch (error) {
            console.error('PDF生成錯誤:', error);
            
            // 移除載入訊息
            const loadingDiv = document.getElementById('pdf-loading');
            if (loadingDiv) {
                document.body.removeChild(loadingDiv);
            }
            
            // 恢復下載按鈕
            const finalActions = document.querySelector('.final-actions');
            if (finalActions) {
                finalActions.style.display = 'flex';
            }
            
            alert('PDF生成失敗，請稍後重試或聯繫技術支援。\nPDF generation failed, please try again or contact technical support.');
        }
    }
}

// 全局實例
let contractPDF = null;

// 頁面載入完成後初始化
document.addEventListener('DOMContentLoaded', function() {
    try {
        // 創建PDF生成器實例
        contractPDF = new ContractPDFGenerator();
        
        // 初始化簽名板
        contractPDF.initializeSignaturePads();
        
        // 設置今天的日期
        const today = new Date();
        const todayString = today.toISOString().split('T')[0];
        const todayDisplay = today.toLocaleDateString('en-GB');
        
        // 安全地設置日期值
        const signingDateEl = document.getElementById('signingDate');
        const companySignatureDateEl = document.getElementById('companySignatureDate');
        const fatherSignatureDateEl = document.getElementById('fatherSignatureDate');
        const motherSignatureDateEl = document.getElementById('motherSignatureDate');
        
        if (signingDateEl) signingDateEl.value = todayString;
        if (companySignatureDateEl) companySignatureDateEl.textContent = todayDisplay;
        if (fatherSignatureDateEl) fatherSignatureDateEl.value = todayDisplay;
        if (motherSignatureDateEl) motherSignatureDateEl.value = todayDisplay;
        
        // 自動同步學生資訊
        const syncStudentInfo = () => {
            try {
                const firstNameEl = document.getElementById('studentFirstName');
                const lastNameEl = document.getElementById('studentLastName');
                const dobEl = document.getElementById('studentDOB');
                const medicalNameEl = document.getElementById('medicalName');
                const medicalDOBEl = document.getElementById('medicalDOB');
                
                const firstName = firstNameEl?.value || '';
                const lastName = lastNameEl?.value || '';
                const dob = dobEl?.value || '';
                
                if (firstName && lastName && medicalNameEl) {
                    medicalNameEl.value = `${firstName} ${lastName}`;
                }
                if (dob && medicalDOBEl) {
                    medicalDOBEl.value = dob;
                }
                
                if (contractPDF) {
                    contractPDF.generateContractNumber();
                }
            } catch (error) {
                console.error('同步學生資訊時發生錯誤:', error);
            }
        };
        
        // 安全地添加事件監聽器
        const studentFirstNameEl = document.getElementById('studentFirstName');
        const studentLastNameEl = document.getElementById('studentLastName');
        const studentDOBEl = document.getElementById('studentDOB');
        const signingDateEl2 = document.getElementById('signingDate');
        
        if (studentFirstNameEl) {
            studentFirstNameEl.addEventListener('input', syncStudentInfo);
        }
        if (studentLastNameEl) {
            studentLastNameEl.addEventListener('input', syncStudentInfo);
        }
        if (studentDOBEl) {
            studentDOBEl.addEventListener('change', syncStudentInfo);
        }
        if (signingDateEl2) {
            signingDateEl2.addEventListener('change', () => {
                if (contractPDF) contractPDF.generateContractNumber();
            });
        }
        
        console.log('✅ 頁面初始化完成');
        
    } catch (error) {
        console.error('頁面初始化時發生錯誤:', error);
    }
});

// 全局函數（供HTML調用）
function clearSignature(canvasId) {
    try {
        if (contractPDF && contractPDF.signatures && contractPDF.signatures[canvasId]) {
            contractPDF.clearSignature(canvasId);
        } else {
            console.warn(`簽名板 ${canvasId} 未找到或未初始化`);
        }
    } catch (error) {
        console.error('清除簽名時發生錯誤:', error);
    }
}

function printContract() {
    try {
        if (contractPDF) {
            contractPDF.generatePDF();
        } else {
            console.error('contractPDF 未初始化');
            alert('系統尚未完全載入，請稍後再試');
        }
    } catch (error) {
        console.error('生成PDF時發生錯誤:', error);
        alert('PDF生成失敗，請稍後重試或聯繫技術支援。');
    }
}

// 窗口大小改變時重新設置canvas
window.addEventListener('resize', function() {
    try {
        if (contractPDF && contractPDF.signatures) {
            setTimeout(() => {
                Object.values(contractPDF.signatures).forEach(signature => {
                    if (signature && signature.setupCanvas) {
                        signature.setupCanvas();
                    }
                });
            }, 100);
        }
    } catch (error) {
        console.error('調整畫布大小時發生錯誤:', error);
    }
});
</script>

</body>
</html>


