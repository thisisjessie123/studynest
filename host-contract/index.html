<!DOCTYPE html>
<html lang="EN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>StudyNest Education Host Agreement</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Dancing+Script:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Calibri', 'Noto Sans SC', sans-serif;
            line-height: 1.4;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-size: 14px;
        }
        
        .chinese-text, [lang="zh"] {
            font-family: 'Noto Sans SC', 'Microsoft YaHei', '微軟雅黑', sans-serif;
        }
        
        .english-text, [lang="en"] {
            font-family: 'Calibri', 'Times New Roman', serif;
        }
        
        .contract-container {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .letterhead {
            background: linear-gradient(135deg, #2c5282 0%, #2d3748 50%, #1a365d 100%);
            color: white;
            padding: 20px 40px;
            text-align: center;
            position: relative;
        }
        
        .letterhead::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(237, 137, 54, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(56, 178, 172, 0.1) 0%, transparent 50%);
            opacity: 0.6;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }
        
        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #a2a8bd 0%, #8792a8 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .logo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 50%);
            border-radius: 50%;
        }
        
        .title-section {
            text-align: left;
            flex-grow: 1;
        }

        .letterhead h1 {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            letter-spacing: 0.5px;
            color: white;
        }
        
        .letterhead .chinese-title {
            font-size: 1.3em;
            font-weight: 600;
            position: relative;
            z-index: 1;
            margin-bottom: 0;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        }
        
        .letterhead .contact-info {
            margin-top: 10px;
            font-size: 0.95em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            font-weight: 400;
            text-align: center;
        }
        
        .contact-info a {
            color: #f6ad55;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .contact-info a:hover {
            color: #ed8936;
            text-shadow: 0 0 8px rgba(237, 137, 54, 0.5);
        }
        
        .contract-content {
            padding: 30px;
        }
        
        .review-date {
            text-align: right;
            margin-bottom: 30px;
            font-style: italic;
            color: #666;
        }
        
        h1, h2, h3 {
            color: #2d3748;
            margin: 20px 0 15px 0;
        }
        
        h1 {
            font-size: 1.6em;
            border-bottom: 3px solid #ed8936;
            padding-bottom: 10px;
        }
        
        h2 {
            font-size: 1.3em;
            color: #2c5282;
        }
        
        h3 {
            font-size: 1.1em;
            color: #2d3748;
        }
        
        h4 {
            font-size: 1.05em;
            color: #2c5282;
            margin: 15px 0 10px 0;
        }
        
        h5 {
            font-size: 1em;
            color: #4a5568;
            margin: 12px 0 8px 0;
            font-weight: 600;
        }
        
        .parties-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border: 2px solid #ddd;
        }
        
        .parties-table td, .parties-table th {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
            vertical-align: middle;
        }
        
        .parties-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .input-field {
            width: 100%;
            padding: 6px 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-family: inherit;
            font-size: 13px;
            transition: border-color 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: background-color 0.3s ease;
            font-size: 13px;
        }
        
        .checkbox-group:hover {
            background: #e9ecef;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
            accent-color: #667eea;
        }
        
        .signature-section {
            margin: 40px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #667eea;
        }
        
        .signature-pad {
            width: 100%;
            height: 120px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            background: white;
            cursor: crosshair;
            display: block;
            touch-action: none;
        }
        
        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .final-actions {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 20px;
            border-top: 3px solid #667eea;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        
        .validation-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1) !important;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .signature-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
        }

        .signature-status.signed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .signature-status.empty {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        @media print {
            .final-actions {
                display: none;
            }
            
            .contract-container {
                box-shadow: none;
                margin: 0;
            }
            
            body {
                background: white;
            }
        }
        
        .elegant-signature {
            font-family: 'Dancing Script', cursive;
            font-size: 2.2em;
            font-weight: 600;
            color: #2c5282;
            text-align: center;
            margin: 10px 0;
            transform: rotate(-2deg);
        }
        
        .chinese-text {
            font-family: 'Noto Sans SC', sans-serif;
            font-weight: 400;
        }

        .content-section {
            padding-left: 20px;
            margin-bottom: 20px;
        }

        .content-section ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .content-section li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
</style>
</head>
<body>
<div class="contract-container">
<div class="letterhead">
<div class="logo-container">
<div class="logo" style="width: 100px; height: 100px; background: rgba(255, 255, 255, 0.5);">
<div style="color: #2c5282; font-size: 24px; font-weight: bold;">SN</div>
</div>
<div class="title-section">
<h1>StudyNest Education</h1>
</div>
</div>
</div>

<div class="contract-content">
<div class="review-date">
<strong>Review Date：August 2025</strong>
</div>

<h1 style="text-align: center;">Short-Term Host Family Agreement</h1>

<h2>Agreement Parties</h2>
<table class="parties-table">
<tr>
<th style="width: 20%;">
<div style="font-size: 0.9em; line-height: 1.3;">
<div><strong>Party A:</strong></div>
</div>
</th>
<td style="width: 40%;">
<input class="input-field" id="parentName" placeholder="Host Family Representative" required type="text"/>
</td>
<td style="width: 40%; font-size: 0.85em; line-height: 1.4;">
<div>(hereinafter referred to as <strong>the Host</strong>)</div>
</td>
</tr>
<tr>
<td style="font-size: 0.9em; line-height: 1.3;">
<div><strong>Address:</strong></div>
</td>
<td colspan="2">
<textarea class="input-field" id="parentAddress" placeholder="Please enter full address" required rows="3"></textarea>
</td>
</tr>
<tr>
<th style="font-size: 0.9em; line-height: 1.3;">
<div><strong>Party B:</strong></div>
</th>
<td><strong>StudyNest Education Limited</strong></td>
<td style="font-size: 0.85em; line-height: 1.4;">
<div>(hereinafter referred to as <strong>StudyNest</strong> or <strong>the Company</strong>)</div>
</td>
</tr>
<tr>
<td style="font-size: 0.9em; line-height: 1.3;">
<div><strong>Address:</strong></div>
</td>
<td colspan="2"><strong>1 Boleyn Way, Barnet, EN5 5LH</strong></td>
</tr>
<tr>
<td style="font-size: 0.9em; line-height: 1.3;">
<div><strong>Contract No.:</strong></div>
</td>
<td colspan="2">
<input class="input-field" id="contractNumberInput" placeholder="Contract number will be auto-generated" readonly style="background-color: #f8f9fa; color: #6c757d;" type="text"/>
</td>
</tr>
<tr>
<td style="font-size: 0.9em; line-height: 1.3;">
<div><strong>Date of Signing:</strong></div>
</td>
<td colspan="2">
<input class="input-field" id="signingDate" readonly required type="date"/>
</td>
</tr>
</table>

<p>By signing this Agreement, both parties agree to abide by the following terms and conditions, including the appended Host Family Responsibilities and Legal Provisions.</p>

<h2>Purpose and Scope</h2>
<div class="content-section">
<p>This Agreement governs the provision of short-term accommodation to students under the care of StudyNest Education Ltd. Placements may include weekends, half-terms, exeats, or emergency situations.</p>
<p>The primary aim is to ensure:</p>
<ul>
<li>Student welfare and safeguarding at all times</li>
<li>A safe, clean, and appropriate hosting environment</li>
<li>Clarity regarding responsibilities, expectations, and conduct</li>
</ul>
</div>

<h2>Booking Process</h2>
<div class="content-section">
<ul>
<li>All placements are coordinated exclusively by StudyNest Education Ltd.</li>
<li>Hosts will be contacted with student details, stay dates, and special requirements.</li>
<li>Hosts must respond to confirm availability within 24 hours.</li>
<li>The Company reserves the right to reallocate students if timely confirmation is not received.</li>
</ul>
</div>

<h2>Host Responsibilities</h2>
<div class="content-section">
<p>The Host Family agrees to:</p>
<ul>
<li>Provide a clean, safe home environment with appropriate facilities</li>
<li>Offer a private bedroom (not shared with any family member)</li>
<li>Supply three daily meals unless otherwise agreed</li>
<li>Supervise the student appropriately and ensure they are never left overnight without an adult</li>
<li>Maintain open communication with the Company and promptly report any issues or concerns</li>
</ul>
<p>Students must not:</p>
<ul>
<li>Stay overnight elsewhere without prior written approval from the Company</li>
<li>Be left unsupervised overnight under any circumstance</li>
</ul>
<p>If a key is not provided, a responsible adult must be present to allow entry at expected times.</p>
</div>

<h2>Safeguarding</h2>
<div class="content-section">
<ul>
<li>All residents aged 16+ must undergo enhanced DBS checks.</li>
<li>The Host agrees to comply with the Company's safeguarding policy at all times.</li>
<li>Any safeguarding concern must be reported immediately to the Company.</li>
</ul>
<p><strong>Safeguarding Contacts:</strong></p>
<p>DSL: Jessie Chang info@studynest.uk</p>
</div>

<h2>Payments</h2>
<div class="content-section">
<ul>
<li>Hosts will be paid the agreed nightly rate by bank transfer within 7 working days following the end of the placement.</li>
<li>The Company is not liable for reimbursement of incidental expenses (e.g., transportation, entertainment, personal items).</li>
</ul>
</div>

<h2>Cancellations</h2>
<div class="content-section">
<ul>
<li>If StudyNest cancels a confirmed booking within one week (7 days) prior to the scheduled arrival date, a goodwill cancellation fee of £50 per week of the confirmed booking will be paid to the Host, up to a maximum of £100.</li>
<li>No cancellation fee will be payable if cancellation is made more than one week prior to the scheduled arrival.</li>
<li>Repeated or unreasonably late cancellations by the Host may result in temporary suspension or removal from the approved host list, at the discretion of StudyNest Education.</li>
</ul>
</div>

<h2>Private Arrangements</h2>
<div class="content-section">
<ul>
<li>Hosts may not enter into direct or private agreements with students or their families.</li>
<li>All placements must be made through StudyNest Education Ltd.</li>
<li>Breach of this clause will result in immediate termination and potential legal action.</li>
</ul>
</div>

<h2>Termination</h2>
<div class="content-section">
<ul>
<li>Either party may terminate this Agreement with 14 days' written notice.</li>
<li>The Company reserves the right to terminate the agreement immediately in the event of any safeguarding concern, misconduct, or breach of contract.</li>
</ul>
</div>

<h2>Legal Provisions</h2>
<div class="content-section">
<p><strong>Indemnity</strong></p>
<p>The Host agrees to indemnify StudyNest Education Ltd from all liabilities resulting from negligence, misconduct, or breach of contract.</p>
<p><strong>Insurance</strong></p>
<p>The Host must maintain appropriate home insurance including third-party liability.</p>
<p><strong>Confidentiality & Data Protection</strong></p>
<p>All student and Company information must be treated as confidential under GDPR and UK Data Protection Act 2018.</p>
<p><strong>Jurisdiction</strong></p>
<p>This Agreement is governed by the laws of England and Wales.</p>
<p><strong>Enforcement</strong></p>
<p>The attached job description and legal provisions form part of this binding agreement.</p>
</div>

<h2>Payment Information</h2>
<p>To ensure prompt and accurate payment following any short-term hosting arrangement, please provide your bank details below. This information will be used solely for the purpose of transferring agreed fees for completed placements.</p>

<h3>Bank Details</h3>
<table class="parties-table">
  <tr>
    <td style="width: 30%;"><strong>Account Name</strong></td>
    <td style="width: 30%;"><strong>Contact Number</strong></td>
  </tr>
  <tr>
    <td>
      <input type="text" name="accountName" id="accountName" class="input-field" placeholder="e.g. John Smith" />
    </td>
    <td>
      <input type="text" name="contactNumber" id="contactNumber" class="input-field" placeholder="e.g. 07123456789" />
    </td>
  </tr>
  <tr>
    <td style="width: 30%;"><strong>Sort Code</strong></td>
    <td style="width: 30%;"><strong>Account Number</strong></td>
  </tr>
  <tr>
    <td>
      <input type="text" name="sortCode" id="sortCode" class="input-field" placeholder="e.g. 12-34-56" />
    </td>
    <td>
      <input type="text" name="accountNumber" id="accountNumber" class="input-field" placeholder="e.g. 12345678" />
    </td>
  </tr>
</table>

<div style="margin: 30px 0; padding: 20px; background: #f0f8ff; border-radius: 10px; border-left: 5px solid #ed8936;">
<h4 style="color: #2d3748;">Declaration</h4>
<p>By signing this Agreement, both parties agree to abide by the following terms and conditions, including the appended Host Family Responsibilities and Legal Provisions.</p>
</div>

<div class="signature-section">
<h4>Host Signature</h4>
<canvas class="signature-pad" id="hostSignature"></canvas>
<div class="signature-controls">
<button class="btn btn-secondary" onclick="clearSignature('hostSignature')" type="button">Clear</button>
</div>
<input class="input-field" id="hostSignatureDate" placeholder="Signature Date" style="margin-top: 10px;" type="text"/>
<div class="signature-status empty">⚠ Please complete signature</div>
</div>

<div class="signature-section">
<h4>StudyNest Education Representative Signature</h4>
<div style="text-align: center; padding: 20px; background: white; border: 2px solid #ddd; border-radius: 8px;">
<div class="elegant-signature">Jessie Chang</div>
<p><strong>StudyNest Education Representative</strong></p>
<p>Date: <span id="companySignatureDate"></span></p>
</div>

<div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border-left: 5px solid #28a745; text-align: center;">
<h4 style="color: #28a745; margin-bottom: 15px; font-size: 1.2em;">✅ Contract Completion</h4>
<p style="margin-bottom: 10px; line-height: 1.6;">
Thank you for completing the online contract. Your electronic signature has been recorded. To finalise the process, please <strong>scroll to the end of the page and click download the signed PDF</strong> and <strong>return it to StudyNest Education</strong> for our records. No further signature is required.
</p>
</div>
</div>

<h2 style="margin-top: 40px; padding-top: 30px; border-top: 3px solid #667eea;">Appendix: Host Family Job Description</h2>
<div class="content-section">
<h3>StudyNest Education Ltd</h3>
<p>Host families play a vital role in supporting the wellbeing and cultural experience of international students placed with them during school breaks or under temporary care. Hosts offer a safe, welcoming, and stable home environment that complements the student's academic journey in the UK. The responsibilities outlined below form part of the agreement between the host family and StudyNest Education Ltd.</p>

<h4>Reporting Structure</h4>
<p>Host families report to the assigned Local Coordinator or StudyNest Guardian responsible for the student's care. For all routine matters, updates, or non-urgent concerns, hosts should communicate directly with their assigned contact.</p>
<p>In case of emergencies, safeguarding issues, or serious incidents, hosts must contact the Designated Safeguarding Lead (DSL) at StudyNest Education without delay.</p>
<p>If the host is also appointed as the student's education guardian, they report directly to the DSL for all matters related to the student's wellbeing.</p>

<h4>Safeguarding & Compliance</h4>
<p>To ensure student safety and meet safeguarding standards:</p>

<h5>Enhanced DBS Checks</h5>
<ul>
<li>All household members aged 16 and over must complete an Enhanced DBS check before hosting.</li>
<li>StudyNest covers the cost for up to two main hosts.</li>
<li>Additional household members will be processed through StudyNest, with subscription responsibilities remaining with the host.</li>
<li>Hosts must subscribe to the DBS Update Service, pay the annual fee, and provide StudyNest with ongoing subscription details.</li>
</ul>

<h5>Training</h5>
<ul>
<li>Hosts must complete online safeguarding training (provided by StudyNest) prior to hosting. This must be renewed annually.</li>
</ul>

<h5>Code of Conduct</h5>
<ul>
<li>Hosts must adhere to the Host Family Code of Conduct, as detailed in the Host Handbook.</li>
</ul>

<h5>Declarations and Checks</h5>
<ul>
<li>A medical declaration confirming fitness to host is required.</li>
<li>Hosts may be asked to undergo a Right to Work check in line with government guidelines.</li>
<li>The main host must hold British Citizenship or Settled Status in the UK.</li>
<li>All household members over 16 must sign a Declaration of Suitability to Host, confirming understanding of safeguarding responsibilities.</li>
</ul>

<h5>References</h5>
<ul>
<li>Both the primary and secondary host must provide two references each, including at least one professional contact (non-family) who has known them for 3+ years.</li>
</ul>

<h5>Policy Compliance</h5>
<p>Hosts agree to follow StudyNest's policies, including:</p>
<ul>
<li>Safeguarding & Child Protection</li>
<li>Health & Safety</li>
<li>E-Safety</li>
<li>Anti-Bullying</li>
<li>Anti-Radicalisation</li>
<li>Missing Student Protocol</li>
</ul>

<h5>Home Inspections</h5>
<ul>
<li>Hosts consent to home visits or inspections by StudyNest, AEGIS, or other official bodies.</li>
</ul>

<h5>Photo Consent</h5>
<ul>
<li>Hosts allow photos of their home to be used for matching and profile purposes.</li>
</ul>

<h4>Hosting Responsibilities</h4>
<p>Students are typically placed during school holidays (half-terms, term breaks, exeats), and occasionally under short-term emergency arrangements.</p>
<p>Hosts must:</p>
<ul>
<li>Provide a safe, inclusive, and caring home.</li>
<li>Support with arranging emergency medical care and inform StudyNest promptly.</li>
<li>Share and exchange contact and emergency details with both the student and StudyNest.</li>
<li>Help students become familiar with local transport and the surrounding area.</li>
<li>Supervise student wellbeing and ensure their whereabouts are known at all times.</li>
<li>Immediately report any changes in household, accommodation, or circumstances.</li>
<li>Not arrange alternative stays unless approved by StudyNest in advance.</li>
<li>Avoid any direct financial arrangements with students or their families.</li>
</ul>

<h4>Communication & Feedback</h4>
<p>Hosts must:</p>
<ul>
<li>Report illness, welfare concerns, or safeguarding issues immediately to StudyNest.</li>
<li>Notify the team if a student does not return home as expected or shows changes in behaviour or wellbeing.</li>
<li>Communicate regarding any overnight stay requests or routine deviations.</li>
<li>Provide feedback after placements when requested (e.g., brief termly reports).</li>
</ul>

<h4>Accommodation Standards</h4>
<p>All host homes must meet StudyNest's minimum accommodation standards:</p>
<p><strong>A private bedroom for each student</strong> (unless a shared room is pre-approved), including:</p>
<ul>
<li>Comfortable bed with clean bedding (changed weekly)</li>
<li>Desk, chair, and lamp for study</li>
<li>Wardrobe and drawer space</li>
<li>Natural light and heating</li>
<li>Access to a lockable bathroom</li>
<li>Weekly laundry services</li>
</ul>

<p><strong>Full board:</strong></p>
<ul>
<li>Breakfast and dinner daily</li>
<li>Lunch during weekends and holidays</li>
<li>Snacks, drinks, and fruit available at all times</li>
</ul>

<p style="margin-top: 20px; font-style: italic;">If you are interested in joining StudyNest's network of caring host families and helping international students feel at home in the UK, please contact us at info@studynest.uk.</p>
</div>

</div>

<div class="final-actions">
<button class="btn btn-primary" onclick="printContract()" type="button">
📄 Download Signed Contract
</button>
</div>

</div>

<script>
// 檢查必要的外部庫是否已載入
function checkLibraries() {
    const missingLibs = [];
    
    if (typeof window.jspdf === 'undefined') {
        missingLibs.push('jsPDF');
    }
    
    if (typeof html2canvas === 'undefined') {
        missingLibs.push('html2canvas');
    }
    
    if (missingLibs.length > 0) {
        console.error('Missing required libraries:', missingLibs.join(', '));
        return false;
    }
    
    return true;
}

// 電子簽名功能類
class SignaturePad {
    constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.isDrawing = false;
        this.hasSignature = false;
        this.lastPos = { x: 0, y: 0 };
        
        this.setupCanvas();
        this.attachEventListeners();
    }
    
    setupCanvas() {
        // 設置canvas尺寸
        const rect = this.canvas.getBoundingClientRect();
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        
        this.canvas.width = rect.width * ratio;
        this.canvas.height = rect.height * ratio;
        
        this.canvas.style.width = rect.width + 'px';
        this.canvas.style.height = rect.height + 'px';
        
        this.ctx.scale(ratio, ratio);
        
        // 設置繪製樣式
        this.ctx.strokeStyle = '#2c3e50';
        this.ctx.lineWidth = 2;
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        this.ctx.imageSmoothingEnabled = true;
    }
    
    attachEventListeners() {
        // 鼠標事件
        this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
        this.canvas.addEventListener('mousemove', (e) => this.draw(e));
        this.canvas.addEventListener('mouseup', () => this.stopDrawing());
        this.canvas.addEventListener('mouseout', () => this.stopDrawing());
        
        // 觸控事件
        this.canvas.addEventListener('touchstart', (e) => this.handleTouch(e));
        this.canvas.addEventListener('touchmove', (e) => this.handleTouch(e));
        this.canvas.addEventListener('touchend', () => this.stopDrawing());
        
        // 防止頁面滾動
        this.canvas.addEventListener('touchstart', (e) => e.preventDefault());
        this.canvas.addEventListener('touchmove', (e) => e.preventDefault());
    }
    
    getPosition(e) {
        const rect = this.canvas.getBoundingClientRect();
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
    }
    
    startDrawing(e) {
        this.isDrawing = true;
        this.lastPos = this.getPosition(e);
        
        // 開始新路徑
        this.ctx.beginPath();
        this.ctx.moveTo(this.lastPos.x, this.lastPos.y);
    }
    
    draw(e) {
        if (!this.isDrawing) return;
        
        const currentPos = this.getPosition(e);
        
        this.ctx.lineTo(currentPos.x, currentPos.y);
        this.ctx.stroke();
        
        this.lastPos = currentPos;
        this.hasSignature = true;
        this.updateStatus();
    }
    
    stopDrawing() {
        if (this.isDrawing) {
            this.isDrawing = false;
            this.ctx.beginPath(); // 結束當前路徑
        }
    }
    
    handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent(
            e.type === 'touchstart' ? 'mousedown' : 'mousemove',
            {
                clientX: touch.clientX,
                clientY: touch.clientY
            }
        );
        this.canvas.dispatchEvent(mouseEvent);
    }
    
    clear() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.hasSignature = false;
        this.updateStatus();
    }
    
    isEmpty() {
        return !this.hasSignature;
    }
    
    getDataURL(type = 'image/png') {
        return this.canvas.toDataURL(type);
    }
    
    updateStatus() {
        const statusEl = this.canvas.parentElement.querySelector('.signature-status');
        if (statusEl) {
            if (this.hasSignature) {
                statusEl.className = 'signature-status signed';
                statusEl.textContent = '✓ Signature completed';
            } else {
                statusEl.className = 'signature-status empty';
                statusEl.textContent = '⚠ Please complete signature';
            }
        }
    }
}

// 生成合約編號
function generateContractNumber() {
    try {
        const hostNameEl = document.getElementById('parentName');

        if (!hostNameEl) {
            console.warn('Contract number generation: Host Family Representative field not found');
            return 'HOST-PENDING-COMPLETION';
        }

        const hostNameRaw = hostNameEl.value?.trim() || '';

        if (hostNameRaw) {
            // 移除特殊字元與多餘空格，保證合約編號格式乾淨
            const hostNameSanitized = hostNameRaw.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '');
            const contractNumber = `HOST-${hostNameSanitized}-2025`;

            const contractNumberInput = document.getElementById('contractNumberInput');
            if (contractNumberInput) {
                contractNumberInput.value = contractNumber;
                contractNumberInput.style.backgroundColor = '#e8f5e8';
                contractNumberInput.style.color = '#2d5a2d';
            } else {
                console.warn('contractNumberInput element not found');
            }

            return contractNumber;
        }

        return 'HOST-PENDING-COMPLETION';
    } catch (error) {
        console.error('Error generating contract number:', error);
        return 'HOST-PENDING-COMPLETION';
    }
}

// PDF生成和下載功能類
class ContractPDFGenerator {
    constructor() {
        this.signatures = {};
    }
    
    // 初始化所有簽名板
    initializeSignaturePads() {
        const signatureCanvases = document.querySelectorAll('.signature-pad');
        
        signatureCanvases.forEach(canvas => {
            this.signatures[canvas.id] = new SignaturePad(canvas);
            
            // 添加狀態顯示元素
            if (!canvas.parentElement.querySelector('.signature-status')) {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'signature-status empty';
                statusDiv.textContent = '⚠ Please complete signature';
                canvas.parentElement.appendChild(statusDiv);
            }
        });
    }
    
    // 清除指定簽名
    clearSignature(canvasId) {
        if (this.signatures[canvasId]) {
            this.signatures[canvasId].clear();
        }
    }

    // 驗證表單
    validateForm() {
        const errors = [];
        const requiredFields = [
            { id: 'parentName', name: 'Host Family Representative' },
            { id: 'parentAddress', name: 'Address' },
            { id: 'accountName', name: 'Account Name' },
            { id: 'contactNumber', name: 'Contact Number' },
            { id: 'sortCode', name: 'Sort Code' },
            { id: 'accountNumber', name: 'Account Number' }
        ];

        // 檢查必填欄位
        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (!element || !element.value.trim()) {
                errors.push(`${field.name} is required`);
                if (element) {
                    element.classList.add('validation-error');
                }
            } else {
                if (element) {
                    element.classList.remove('validation-error');
                }
            }
        });

        // 檢查簽名
        if (this.signatures['hostSignature'] && this.signatures['hostSignature'].isEmpty()) {
            errors.push('Host signature is required');
        }

        return {
            isValid: errors.length === 0,
            errors: errors
        };
    }
    
    // 生成並下載PDF
    async generatePDF() {
        try {
            // 驗證表單
            const validation = this.validateForm();
            if (!validation.isValid) {
                alert('Please complete the following items before downloading the contract:\n\n' + validation.errors.join('\n'));
                return;
            }
            
            // 生成合約編號
            generateContractNumber();
            
            // 隱藏下載按鈕
            const finalActions = document.querySelector('.final-actions');
            if (finalActions) {
                finalActions.style.display = 'none';
            }
            
            // 顯示載入訊息
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'pdf-loading';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                font-family: inherit;
            `;
            loadingDiv.innerHTML = `
                <div style="font-size: 18px; margin-bottom: 15px;">📄 Generating PDF Contract...</div>
                <div style="font-size: 14px; color: #666;">Please wait...</div>
                <div style="margin-top: 15px;">
                    <div style="width: 200px; height: 4px; background: #f0f0f0; border-radius: 2px; overflow: hidden;">
                        <div style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 2px; animation: progress 3s ease-in-out infinite;"></div>
                    </div>
                </div>
                <style>
                    @keyframes progress {
                        0% { width: 0%; }
                        50% { width: 70%; }
                        100% { width: 100%; }
                    }
                </style>
            `;
            document.body.appendChild(loadingDiv);
            
            // 等待一點時間讓UI更新
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 使用html2canvas捕獲整個合約內容
            const contractContainer = document.querySelector('.contract-container');
            
            const canvas = await html2canvas(contractContainer, {
                scale: 2, // 高品質
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: contractContainer.offsetWidth,
                height: contractContainer.offsetHeight,
                scrollX: 0,
                scrollY: 0
            });
            
            // 創建PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // 計算圖片尺寸以適應A4
            const imgWidth = 210; // A4寬度
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            // 如果內容太長，分頁處理
            let heightLeft = imgHeight;
            let position = 0;
            
            // 添加第一頁
            pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= 297; // A4高度
            
            // 如果需要分頁
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= 297;
            }
            
            // 生成檔案名稱
            const contractNumber = generateContractNumber();
            const hostName = document.getElementById('parentName').value.trim() || 'Host';
            const fileName = `StudyNest_Contract_${contractNumber}_${hostName}.pdf`;
            
            // 下載PDF
            pdf.save(fileName);
            
            // 移除載入訊息
            document.body.removeChild(loadingDiv);
            
            // 恢復下載按鈕
            if (finalActions) {
                finalActions.style.display = 'flex';
            }
            
            // 顯示成功訊息
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #d4edda;
                color: #155724;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-family: inherit;
                border: 1px solid #c3e6cb;
            `;
            successDiv.innerHTML = `
                <div style="font-weight: bold;">✅ PDF Download Successful!</div>
                <div style="font-size: 12px; margin-top: 5px;">Please send back to StudyNest Education</div>
            `;
            document.body.appendChild(successDiv);
            
            // 3秒後移除成功訊息
            setTimeout(() => {
                if (document.body.contains(successDiv)) {
                    document.body.removeChild(successDiv);
                }
            }, 3000);
            
        } catch (error) {
            console.error('PDF generation error:', error);
            
            // 移除載入訊息
            const loadingDiv = document.getElementById('pdf-loading');
            if (loadingDiv) {
                document.body.removeChild(loadingDiv);
            }
            
            // 恢復下載按鈕
            const finalActions = document.querySelector('.final-actions');
            if (finalActions) {
                finalActions.style.display = 'flex';
            }
            
            alert('PDF generation failed, please try again or contact technical support.');
        }
    }
}

// 全局實例
let contractPDF = null;

// 頁面載入完成後初始化
document.addEventListener('DOMContentLoaded', function() {
    try {
        // 創建PDF生成器實例
        contractPDF = new ContractPDFGenerator();
        
        // 初始化簽名板
        contractPDF.initializeSignaturePads();
        
        // 設置今天的日期
        const today = new Date();
        const todayString = today.toISOString().split('T')[0];
        const todayDisplay = today.toLocaleDateString('en-GB');
        
        // 安全地設置日期值
        const signingDateEl = document.getElementById('signingDate');
        const companySignatureDateEl = document.getElementById('companySignatureDate');
        const hostSignatureDateEl = document.getElementById('hostSignatureDate');
        
        if (signingDateEl) signingDateEl.value = todayString;
        if (companySignatureDateEl) companySignatureDateEl.textContent = todayDisplay;
        if (hostSignatureDateEl) hostSignatureDateEl.value = todayDisplay;
        
        // 自動生成合約編號
        const generateContractNumberOnChange = () => {
            try {
                generateContractNumber();
            } catch (error) {
                console.error('Error updating contract number:', error);
            }
        };
        
        // 安全地添加事件監聽器
        const parentNameEl = document.getElementById('parentName');
        const signingDateEl2 = document.getElementById('signingDate');
        
        if (parentNameEl) {
            parentNameEl.addEventListener('input', generateContractNumberOnChange);
        }
        if (signingDateEl2) {
            signingDateEl2.addEventListener('change', generateContractNumberOnChange);
        }
        
        console.log('✅ Page initialization completed');
        
    } catch (error) {
        console.error('Error during page initialization:', error);
    }
});

// 全局函數（供HTML調用）
function clearSignature(canvasId) {
    try {
        if (contractPDF && contractPDF.signatures && contractPDF.signatures[canvasId]) {
            contractPDF.clearSignature(canvasId);
        } else {
            console.warn(`Signature pad ${canvasId} not found or not initialized`);
        }
    } catch (error) {
        console.error('Error clearing signature:', error);
    }
}

function printContract() {
    try {
        if (contractPDF) {
            contractPDF.generatePDF();
        } else {
            console.error('contractPDF not initialized');
            alert('System not fully loaded, please try again later');
        }
    } catch (error) {
        console.error('Error generating PDF:', error);
        alert('PDF generation failed, please try again or contact technical support.');
    }
}

// 窗口大小改變時重新設置canvas
window.addEventListener('resize', function() {
    try {
        if (contractPDF && contractPDF.signatures) {
            setTimeout(() => {
                Object.values(contractPDF.signatures).forEach(signature => {
                    if (signature && signature.setupCanvas) {
                        signature.setupCanvas();
                    }
                });
            }, 100);
        }
    } catch (error) {
        console.error('Error adjusting canvas size:', error);
    }
});
</script>

</body>
</html>
